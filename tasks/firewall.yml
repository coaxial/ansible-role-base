---
- name: Check apt sources
  ansible.builtin.command: cat /etc/apt/sources.list
  register: sources
- name: Debug sources
  ansible.builtin.debug:
    msg: "{{ sources.stdout }}"

- name: Check if UFW is available in apt cache
  ansible.builtin.command: apt-cache policy ufw
  register: ufw_policy
  become: true
  ignore_errors: true

- name: Debug UFW availability
  ansible.builtin.debug:
    msg: "UFW policy: {{ ufw_policy.stdout | default('Not found') }}"

- name: Ensure UFW is present
  ansible.builtin.apt:
    name: ufw
    state: present
    force: yes # Forces install even if cache seems stale
  become: true
- name: Ensure UFW is present
  ansible.builtin.apt:
    name: ufw
    state: present

- name: Allow localhost traffic
  community.general.ufw:
    rule: allow
    from_ip: 127.0.0.0/8
    comment: Allow loopback traffic

- name: Allow SSH
  community.general.ufw:
    rule: allow
    port: 22
    proto: tcp
    comment: Allow SSH traffic

- name: Set incoming default policy to deny
  community.general.ufw:
    direction: incoming
    policy: deny

- name: Set outgoing default policy to allow
  community.general.ufw:
    direction: outgoing
    policy: allow

- name: Set routed default policy to deny
  community.general.ufw:
    direction: routed
    policy: deny

- name: Enable UFW
  community.general.ufw:
    state: enabled
