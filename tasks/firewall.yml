---
- name: Ensure iptables is present
  package:
    name: "{{ item }}"
    state: present
  with_items:
    - iptables
    - iptables-persistent

- name: Set default policy to DROP
  iptables:
    chain: "{{ item }}"
    policy: DROP
  with_items:
    - INPUT
    - FORWARD
    - OUTPUT
  notify: Persist iptables rules

- name: Allow SSH
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: 22
    jump: ACCEPT
    ip_version: "{{ item }}"
    comment: Allow SSH traffic
  with_items:
    - ipv4
    - ipv6
  notify: Persist iptables rules
